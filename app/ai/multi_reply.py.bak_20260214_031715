import os
import random
from typing import List, Dict
import httpx
import yaml

OLLAMA_URL = os.getenv("OLLAMA_URL", "http://127.0.0.1:11434")
OLLAMA_MODEL = os.getenv("OLLAMA_MODEL", "llama3.1:8b")

BASE_DIR = os.path.dirname(__file__)
JP_PATH = os.path.join(BASE_DIR, "personas_jp.yaml")
EN_PATH = os.path.join(BASE_DIR, "personas_en.yaml")

def _load_yaml(path: str) -> Dict:
    with open(path, "r", encoding="utf-8") as f:
        return yaml.safe_load(f) or {}

def _ollama(prompt: str, temperature: float, num_predict: int) -> str:
    payload = {
        "model": OLLAMA_MODEL,
        "prompt": prompt,
        "stream": False,
        "options": {"temperature": temperature, "num_predict": num_predict},
    }
    with httpx.Client(timeout=30.0) as client:
        r = client.post(f"{OLLAMA_URL}/api/generate", json=payload)
        r.raise_for_status()
        return (r.json().get("response") or "").strip()

def generate_multi_replies(user_text: str, lang: str, context: str = "", specific_persona: str = "") -> List[Dict[str, str]]:
    user_text = (user_text or "").strip()
    if not user_text:
        return [{"name": "Anon" if lang == "en" else "風吹けば名無し", "content": "(empty)"}]

    cfg = _load_yaml(EN_PATH if lang == "en" else JP_PATH)
    personas = cfg.get("personas", [])
    settings = cfg.get("settings", {})
    max_replies = int(settings.get("max_replies", 3))
    temperature = float(settings.get("temperature", 0.8))
    num_predict = int(settings.get("num_predict", 180))

    picked = []
    if specific_persona:
        found = next((p for p in personas if p["name"] == specific_persona), None)
        if found:
            picked = [found]
        else:
            random.shuffle(personas)
            picked = personas[:1]
    else:
        random.shuffle(personas)
        picked = personas[:max_replies] if personas else [{"name": "Anon", "role": "short reply"}]

    replies = []
    for p in picked:
        pname = p.get("name", "Anon" if lang == "en" else "名無し")
        role = p.get("role", "")

        if lang == "en":
            system = f"""You are an anonymous message board user.
Write in English only. Short 1-3 lines. Internet-forum vibe. No hate, no harassment, no illegal instructions, no personal data requests.
Your role: {role}
"""
        else:
            system = f"""あなたは匿名掲示板の住人。
日本語のみ。短文1〜3行。2chっぽい空気。ただし差別/誹謗中傷/違法助言/個人情報の要求は禁止。
あなたの役割: {role}
"""

        prompt = f"""{system}

(THREAD CONTEXT)
{context}

(POST)
{user_text}

REPLY:
"""
        try:
            text = _ollama(prompt, temperature=temperature, num_predict=num_predict)
            if not text:
                text = "草" if lang != "en" else "lol"
        except Exception as e:
            text = f"(AI error: {type(e).__name__})" if lang == "en" else f"（AIエラー: {type(e).__name__}）"

        text = text.strip()[:500]
        replies.append({"name": pname, "content": text})

    return replies
